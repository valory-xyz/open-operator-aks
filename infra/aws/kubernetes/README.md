Steps:

# Domain

1. Obtain a domain name (e.g. from GoDaddy).
2. Create an AWS Route 53 Hosted zone
3. Update the purchased domain with NS entry to point AWS Hosted zone Name servers (Route 53 - Hosted Zones - hosted_zone - Hosted zone details)

## Configure AWS CLI credentials

Create an IAM user with roles ... 

## Deploy infrastructure with Terraform

Required to apply in 2 steps because of filesystem dependencies.

```bash
terraform apply -target=module.aws_cluster
terraform apply
```

## Test AWS EFS

Ensure that VPC is set to the vpc id generated by the terraform deployment.

Ensure that security groups for EFS are selected for both the controller and the workers's security groups

Go to each of the EC2 security groups and update the inbound rule to allow
inbound `tcp:2049` for the SECURITY_GROUP created for the deployment.

Confirm that it is possible to mount a drive onto the worker nodes of the cluster

```bash
ssh core@IP_OF_EC2_WORKER_NODE
```

attempt to mount manually:

```bash
export EFS_ACCESS_POINT_IP=10.0.27.12
sudo mkdir /mnt/efs
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport $EFS_ACCESS_POINT_IP:/ /mnt/efs

```

## Access Kubernetes dashboard



[https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/]

[https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md]

Execute in a separate terminal:

```bash
#KUBECONFIG must point to the appropriate file generated with Terraform. See main.tf.
export KUBECONFIG=$PWD/kubefiles/kubeconfig
kubectl get nodes

kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

kubectl apply -f ~/git/open-operator-aks-tests/infra/dashboard-admin.yaml 
kubectl -n kubernetes-dashboard create token admin-user
kubectl proxy

# Login on :
# http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/.
```

## Apply Helm nfs-subdir-external provisioner

```bash
helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
--set nfs.server=A.B.C.D \
--set nfs.path=/ \
--set storageClass.name=nfs-ephemeral \
--set storageClass.archiveOnDelete=false
```

## Apply service deployment

```bash
cd <service/abci_build>
kubectl apply --recursive -f .
```



